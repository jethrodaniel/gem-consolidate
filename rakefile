require "bundler/gem_tasks"

def be cmd
  sh "bundle exec #{cmd}"
end

##

task :default => %i[test install fib]

task :test do
  Dir.chdir("example") { sh "bundle exec bench test" }
  be "bench test/test_*.rb"
end

task :snapshot do
  be "exe/consolidate example/lib/fib.rb > test/snapshot.rb"
end

##

task :fib => "fib.bundle.rb" do |t|
  sh "ruby #{t.source}"
end

file "fib.bundle.rb" do |t|
  be "gem consolidate example/lib/fib.rb --footer='1.upto(10).each{|n|p Fib.fibonacci(n)}' > #{t.name}"
end
